#!/bin/bash

####################################################################
# aws_ec2_submit_docker_basecall.txt (Change file name as fit)
#
# This is a sample script to pass as the second argument into
# aws_ec2_launch_gpu_instance.sh. You should make a copy of this file
# and change it to a unique name for each run that you do.
#
# Make sure you update all variables in this file for a particular experiment.
#
# Revision History
# 2019.09.08 Created by Brian Yu
# 2019.09.08 Removed --rm and -it in docker run,
#            otherwise will get a not TTY error
# 2019.09.09 /bin/bash -c is not needed
#            Using Bryan Merrill's latest docker where 'cp -pr * $LOCAL/'
#            is commented out. Also need to wait until container exits.
#####################################################################

# Docker run command
docker container run --runtime=nvidia \
-e coreNum=8 \
-e mem_mb=60000 \
-e NANOPORE_RUNPATH=s3://FILL/IN/PATH \
-e RUN_NAME=FILL_IN_RUN_NAME \
-e barcoded=no \
-e flowcell=FLO-MIN106 \
-e kit=SQK-LSK109 \
-e barcodekit=EXP-NBD104 \
-e DATA_DEST=s3://FILL/IN/PATH \
--name=nanopore_container \
brianyu2010/nanopore_basecall_demux_gpu:latest "./nanopore_basecall_demux.sh"

# Wait until the process finishes before executing the next command
docker wait nanopore_container
# touch nanopore_basecall_demux_completed.txt

# Shutdown, therefore terminate instance
shutdown -h now
